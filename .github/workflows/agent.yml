# Shim workflow â€” copy this to your target repo at .github/workflows/agent.yml
#
# This is all you need in each repo that uses Remote Dev Bot.
# The real logic lives in gnovak/remote-dev-bot and updates automatically.
#
# Prerequisites (see runbook.md for details):
#   - Repository secrets: at least one LLM API key (ANTHROPIC_API_KEY, OPENAI_API_KEY, or GEMINI_API_KEY)
#   - Actions permissions: read/write + allow PR creation
#
# Optional (for bot identity / CI triggering):
#   - RDB_APP_ID (repo variable) + RDB_APP_PRIVATE_KEY (repo secret): GitHub App for bot identity
#   - RDB_PAT_TOKEN (repo secret): PAT for CI triggering (bot posts as PAT owner)
#   - Without either, github.token is used (bot posts as github-actions[bot], no CI on bot PRs)
#
# Note: secrets must be passed explicitly (not via `secrets: inherit`) because
# GitHub Actions does not pass inherited secrets across different repo owners.
#
# This test repo points at @e2e-test (the ephemeral test pointer for remote-dev-bot development).
# External users should point at @main; to track pre-release features, use @dev.

name: Remote Dev Bot

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  resolve:
    # Security gate: only allow trusted users to trigger agent runs.
    # OWNER = repo owner, COLLABORATOR = explicitly invited, MEMBER = org member.
    # This prevents arbitrary users from triggering runs that consume API credits.
    # To restrict further, remove roles from the list (e.g., '["OWNER"]' for owner-only).
    # Supports both "/agent-resolve" (dash) and "/agent resolve" (space) syntax.
    if: >
      (github.event.issue || github.event.pull_request) &&
      (startsWith(github.event.comment.body, '/agent-') || startsWith(github.event.comment.body, '/agent ')) &&
      contains(fromJson('["OWNER","COLLABORATOR","MEMBER"]'), github.event.comment.author_association)
    uses: gnovak/remote-dev-bot/.github/workflows/remote-dev-bot.yml@e2e-test
    with:
      rdb_ref: e2e-test
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      RDB_PAT_TOKEN: ${{ secrets.RDB_PAT_TOKEN }}
      RDB_APP_PRIVATE_KEY: ${{ secrets.RDB_APP_PRIVATE_KEY }}